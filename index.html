<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Storybook Reader ‚Äì Flipbook + Read-Aloud</title>
  <meta name="description" content="Beautiful page-turning PDF reader with search and read-aloud." />
  <style>
    :root{
      --bg:#0f1220; --panel:#141832; --muted:#90a0d8; --brand:#7dd3fc; --accent:#fdbb2d;
      --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(160deg,#0f1220,#0b1222 60%);color:#e8ecff;
         font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;min-height:100vh}
    header{position:sticky;top:0;z-index:10;background:rgba(10,12,25,.75);
           backdrop-filter:saturate(150%) blur(8px);border-bottom:1px solid #1e2342}
    .wrap{max-width:1100px;margin:auto;padding:18px}
    .brand{display:flex;align-items:center;gap:.75rem}
    .logo{width:38px;height:38px;border-radius:10px;background:conic-gradient(from -30deg,#7dd3fc,#2dd4bf,#a78bfa,#60a5fa,#7dd3fc);box-shadow:inset 0 0 30px rgba(255,255,255,.35),var(--shadow)}
    h1{margin:0;font-size:1.2rem;letter-spacing:.4px}
    .sub{color:var(--muted);font-size:.9rem}
    .flex{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    input[type="search"]{flex:1;min-width:260px;padding:12px 14px;border-radius:12px;border:1px solid #2a2f55;background:#0d1230;color:#e8ecff}
    .btn{display:inline-flex;align-items:center;gap:.5rem;border:1px solid #2b315b;background:#121735;color:#e8ecff;padding:10px 14px;border-radius:12px;cursor:pointer;transition:.25s;box-shadow:var(--shadow)}
    .btn:hover{transform:translateY(-1px);background:#151b3f}
    .btn.primary{background:linear-gradient(135deg,#2563eb,#7c3aed);border-color:transparent}
    .btn.success{background:linear-gradient(135deg,#22c55e,#06b6d4);border-color:transparent}

    /* library */
    #library{max-width:1100px;margin:26px auto;padding:0 18px 40px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:18px}
    .card{
      background:linear-gradient(180deg,#121735,#0f1433);
      border:1px solid #202553;border-radius:16px;overflow:hidden;box-shadow:var(--shadow);
      display:flex;flex-direction:column;cursor:pointer
    }
    .cover-wrap{padding:10px 10px 0}
    .cover{
      width:100%;height:0;padding-bottom:66%;
      border-radius:12px;overflow:hidden;position:relative;background:#0e1538
    }
    .cover img{
      position:absolute;inset:0;width:100%;height:100%;object-fit:cover;display:block;filter:contrast(1.02)
    }
    /* fallback bg */
    .cover.fallback{
      background:#0e1538 url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 260"><defs><linearGradient id="g" x1="0" x2="1"><stop offset="0" stop-color="%233b82f6"/><stop offset="1" stop-color="%239159f9"/></linearGradient></defs><rect width="400" height="260" fill="%230e1538"/><circle cx="320" cy="80" r="90" fill="url(%23g)" opacity=".35"/><circle cx="120" cy="190" r="120" fill="url(%23g)" opacity=".18"/></svg>') center/cover no-repeat;
    }
    .meta{padding:12px 14px 6px}
    .title{font-weight:600;line-height:1.3}
    .author{color:var(--muted);font-size:.9rem;margin-top:4px}
    .actions{display:flex;gap:8px;padding:10px 14px 16px;margin-top:auto}
    .actions .btn{flex:1;justify-content:center}

    /* viewer */
    #viewer{position:fixed;inset:0;background:rgba(4,7,20,.85);backdrop-filter:blur(6px);display:none;align-items:center;justify-content:center;padding:24px}
    #viewer.open{display:flex}
    .book-shell{width:min(980px,95vw);height:min(640px,80vh);display:grid;grid-template-columns:1fr;gap:16px}
    .toolbar{display:flex;align-items:center;gap:10px;justify-content:space-between}
    .toolbar .left,.toolbar .right{display:flex;align-items:center;gap:8px}
    .book{position:relative;perspective:1600px;border-radius:18px;background:#0b1028;border:1px solid #23284e;box-shadow:var(--shadow);overflow:hidden}
    .spread{position:absolute;inset:0;display:grid;grid-template-columns:1fr 1fr}
    .page{position:relative;border-right:1px solid #1c2147}
    .page:last-child{border-right:0;border-left:1px solid #1c2147}
    canvas{display:block;width:100%;height:100%;object-fit:contain;background:#0c132e}

    .turn{position:absolute;top:0;bottom:0;right:0;width:50%;transform-origin:left center;transform:rotateY(0deg);box-shadow:0 6px 25px rgba(0,0,0,.45)}
    .turn.flip{animation:flip 650ms cubic-bezier(.5,.05,.2,1)}
    @keyframes flip{to{transform:rotateY(-180deg)}}

    .kbd{padding:.2rem .45rem;border:1px solid #2a2f55;border-bottom-width:2px;border-radius:6px;background:#0e1330;margin:0 .2rem}
    .pill{font-size:.8rem;border:1px solid #27305d;background:#0e1436;padding:.35rem .6rem;border-radius:999px}
    .footer{color:#9aa4d9;text-align:center;font-size:.85rem;padding:16px}

    @media (max-width:720px){
      .book-shell{height:min(82vh,680px)}
      .spread{grid-template-columns:1fr}
      .page{border:0}
      .turn{display:none}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Storybook Reader</h1>
          <div class="sub">Flip through PDFs with search & read-aloud</div>
        </div>
      </div>

      <div class="flex" style="margin-top:12px">
        <input id="q" type="search" placeholder="Search by title or author‚Ä¶ (‚åò/Ctrl + K)" />
        <label class="btn">
          <input id="addFile" type="file" accept="application/pdf" hidden>
          ‚ûï Add PDF
        </label>
        <button id="trySample" class="btn success">üìñ Open sample (books/sample.pdf)</button>
      </div>
    </div>
  </header>

  <main id="library" class="wrap">
    <h2 style="margin:10px 0 8px">Your Library</h2>
    <div id="grid" class="grid"></div>
    <div class="footer">
      Tip: Click a book to open, then use <span class="kbd">‚Üê</span><span class="kbd">‚Üí</span> to turn pages, or press <span class="kbd">R</span> to read the current page aloud.
    </div>
  </main>

  <!-- Viewer -->
  <div id="viewer" role="dialog" aria-modal="true" aria-label="Book reader">
    <div class="book-shell">
      <div class="toolbar">
        <div class="left">
          <button class="btn" id="closeBtn">‚úñ Close</button>
          <button class="btn" id="prevBtn">‚¨Ö Prev</button>
          <button class="btn" id="nextBtn">Next ‚û°</button>
          <span class="pill" id="pageInfo">Page 1 / 1</span>
        </div>
        <div class="right">
          <button class="btn" id="readBtn">üîä Read page</button>
          <label class="btn">üîÅ Auto-read
            <input id="autoRead" type="checkbox" style="accent-color:#22c55e;margin-left:6px">
          </label>
          <select id="voiceSelect" class="btn" style="padding:.55rem .7rem"></select>
          <a id="downloadBtn" class="btn primary" download>‚¨á Download PDF</a>
        </div>
      </div>

      <div class="book">
        <div class="spread">
          <div class="page"><canvas id="left"></canvas></div>
          <div class="page"><canvas id="right"></canvas></div>
        </div>
      </div>
    </div>
  </div>

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" defer></script>
  <script>
    window.addEventListener('load', () => {
      const grid = document.getElementById('grid');
      const search = document.getElementById('q');
      const addFile = document.getElementById('addFile');
      const trySample = document.getElementById('trySample');

      // ---- Library: add books here ----
      // Tip: put covers in assets/covers/ and PDFs in books/
      let LIBRARY = [
        {
          id: 'book1',
          title: 'The Kingdom of Prime Numbers ‚Äî Book 1',
          author: 'John Lincoln Wilborn',
          href: 'books/book1.pdf',
          cover: 'assets/covers/book1.jpg'
        },
        {
          id: 'book2',
          title: 'The Kingdom of Prime Numbers ‚Äî Book 2',
          author: 'John Lincoln Wilborn',
          href: 'books/book2.pdf',
          cover: 'assets/covers/book2.png'
        },
        // Sample entry (use your own file in /books/)
        {
          id: 'sample',
          title: 'Sample Story',
          author: 'Your Author',
          href: 'books/sample.pdf',
          cover: '' // leave blank to see fallback
        }
      ];

      function bookCard(b){
        const el = document.createElement('article');
        el.className = 'card';
        el.innerHTML = `
          <div class="cover-wrap">
            <div class="cover ${b.cover ? '' : 'fallback'}">
              ${b.cover ? `<img loading="lazy" src="${b.cover}" alt="Cover of ${escapeHtml(b.title)}">` : ''}
            </div>
          </div>
          <div class="meta">
            <div class="title">${b.title}</div>
            <div class="author">${b.author || 'Unknown author'}</div>
          </div>
          <div class="actions">
            <button class="btn open">Open</button>
            <a class="btn" href="${b.href}" download>Download</a>
          </div>
        `;
        // Open on card click or button
        el.onclick = (e)=>{ if(!e.target.closest('a,button')) openBook(b); };
        el.querySelector('.open').onclick = (e)=>{ e.stopPropagation(); openBook(b); };
        return el;
      }

      function renderLibrary(){
        grid.innerHTML = '';
        const q = search.value.trim().toLowerCase();
        LIBRARY
          .filter(b => !q || b.title.toLowerCase().includes(q) || (b.author||'').toLowerCase().includes(q))
          .forEach(b => grid.appendChild(bookCard(b)));
        if(!grid.children.length){
          const empty = document.createElement('div');
          empty.style.cssText = 'grid-column:1/-1;text-align:center;color:#9aa4d9;padding:40px 0;';
          empty.innerHTML = 'No books yet. Click <b>‚ûï Add PDF</b> or use the sample.';
          grid.appendChild(empty);
        }
      }

      search.addEventListener('input', renderLibrary);
      document.addEventListener('keydown', e=>{
        if((e.metaKey||e.ctrlKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); search.focus(); }
      });

      // Add local PDF (shows without a cover; you can add one by editing LIBRARY)
      addFile.addEventListener('change', async (e)=>{
        const file = e.target.files[0];
        if(!file) return;
        const title = prompt('Book title?', file.name.replace(/\.pdf$/i,'')) || 'Untitled';
        const author = prompt('Author? (optional)','');
        const url = URL.createObjectURL(file);
        const id = crypto.randomUUID();
        LIBRARY.unshift({ id, title, author, href:url, cover:'' });
        renderLibrary();
        openBook(LIBRARY[0]);
        addFile.value='';
      });

      trySample.addEventListener('click', ()=>{
        const sample = LIBRARY.find(b=>b.id==='sample');
        if(!sample){ alert('No sample entry in library. Add one under LIBRARY array.'); return; }
        openBook(sample);
      });

      // ---------- Viewer + PDF rendering ----------
      const viewer = document.getElementById('viewer');
      const leftCanvas = document.getElementById('left');
      const rightCanvas = document.getElementById('right');
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const pageInfo = document.getElementById('pageInfo');
      const closeBtn = document.getElementById('closeBtn');
      const downloadBtn = document.getElementById('downloadBtn');

      let pdfDoc = null, current = 1, total = 1, currentBook = null;

      function openBook(book){
        // PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc =
          'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        currentBook = book;
        downloadBtn.href = book.href;
        viewer.classList.add('open');
        document.body.style.overflow = 'hidden';
        loadPdf(book.href);
      }
      function closeBook(){
        viewer.classList.remove('open');
        document.body.style.overflow = '';
        stopSpeech();
      }
      closeBtn.onclick = closeBook;

      async function loadPdf(url){
        try{
          stopSpeech();
          const loading = await pdfjsLib.getDocument(url).promise;
          pdfDoc = loading; total = pdfDoc.numPages; current = 1;
          await renderSpread();
        }catch(err){
          alert('Failed to load PDF: '+err.message+ '\nMake sure your PDF path is correct (e.g., books/book1.pdf).');
        }
      }

      function fitCanvas(canvas){
        const dpr = Math.max(1, window.devicePixelRatio || 1);
        const w = canvas.clientWidth*dpr, h = canvas.clientHeight*dpr;
        if(canvas.width!==w || canvas.height!==h){ canvas.width=w; canvas.height=h; }
        return {w,h,scale:dpr};
      }

      async function renderPageTo(canvas, pageNum){
        const page = await pdfDoc.getPage(pageNum);
        const viewport = page.getViewport({scale:1});
        const {w,h} = fitCanvas(canvas);
        const scale = Math.min(w/viewport.width, h/viewport.height);
        const vp = page.getViewport({scale});
        const ctx = canvas.getContext('2d');
        ctx.setTransform(1,0,0,1,0,0); ctx.clearRect(0,0,canvas.width,canvas.height);
        const renderContext = { canvasContext: ctx, viewport: vp, transform:[1,0,0,1,(w-vp.width)/2,(h-vp.height)/2] };
        await page.render(renderContext).promise;
      }

      async function renderSpread(){
        pageInfo.textContent = `Page ${current} / ${total}`;
        await renderPageTo(leftCanvas, Math.max(1, current));
        if(current+1<=total) await renderPageTo(rightCanvas, current+1);
        else { const ctx=rightCanvas.getContext('2d'); ctx.clearRect(0,0,rightCanvas.width,rightCanvas.height); }
        if(document.getElementById('autoRead').checked){ readCurrentPage(); }
      }

      function createTurnOverlay(canvas){
        const turn = document.createElement('canvas');
        turn.width = canvas.width; turn.height = canvas.height; turn.className='turn';
        turn.getContext('2d').drawImage(canvas,0,0);
        canvas.parentElement.appendChild(turn);
        turn.addEventListener('animationend', ()=> turn.remove());
        return turn;
      }

      function turn(direction){
        if(direction==='next' && current+1<=total){
          createTurnOverlay(rightCanvas).classList.add('flip');
          current = Math.min(current+2, total - (total%2 ? 0:1));
          setTimeout(renderSpread, 620);
        } else if(direction==='prev' && current-2>=1){
          current = current-2; renderSpread();
        }
      }

      prevBtn.onclick = ()=> turn('prev');
      nextBtn.onclick = ()=> turn('next');
      document.addEventListener('keydown', (e)=>{
        if(!viewer.classList.contains('open')) return;
        if(e.key==='ArrowRight') nextBtn.click();
        if(e.key==='ArrowLeft') prevBtn.click();
        if(e.key.toLowerCase()==='r') readBtn.click();
        if(e.key==='Escape') closeBtn.click();
      });
      window.addEventListener('resize', ()=>{ if(pdfDoc) renderSpread(); });

      // ---------- Text-to-Speech ----------
      const readBtn = document.getElementById('readBtn');
      const voiceSelect = document.getElementById('voiceSelect');

      function populateVoices(){
        const voices = speechSynthesis.getVoices().filter(v=>/en|fr|es|us|uk/i.test(v.lang));
        voiceSelect.innerHTML = voices.map(v=>`<option value="${v.name}">${v.name} ‚Äî ${v.lang}</option>`).join('');
      }
      populateVoices();
      if('onvoiceschanged' in speechSynthesis){ speechSynthesis.onvoiceschanged = populateVoices; }

      function stopSpeech(){ speechSynthesis.cancel(); readBtn.textContent = 'üîä Read page'; }

      async function readCurrentPage(){
        try{
          stopSpeech();
          const page = await pdfDoc.getPage(current);
          const tc = await page.getTextContent();
          const text = tc.items.map(i=>i.str).join(' ').replace(/\s+/g,' ').trim();
          if(!text){ alert('No selectable text found on this page.'); return; }
          const utter = new SpeechSynthesisUtterance(text);
          const chosen = speechSynthesis.getVoices().find(v=>v.name===voiceSelect.value);
          if(chosen) utter.voice = chosen;
          utter.rate = 1; utter.pitch = 1;
          utter.onend = ()=>{ readBtn.textContent = 'üîä Read page'; };
          speechSynthesis.speak(utter);
          readBtn.textContent = '‚è∏ Stop';
        }catch(e){ alert('Unable to read page: '+e.message); }
      }
      readBtn.addEventListener('click', ()=>{
        if(speechSynthesis.speaking) stopSpeech(); else readCurrentPage();
      });

      // helpers
      function escapeHtml(s){ return s.replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',\"'\":'&#39;'}[c])); }

      // initial render
      renderLibrary();
    });
  </script>
</body>
</html>
